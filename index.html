<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Field Trip Attendance Dashboard - FY25</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 1.75rem; color: #1a1a2e; margin-bottom: 8px; }
    .subtitle { color: #64748b; margin-bottom: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); align-items: flex-end; }
    .filter-group { display: flex; flex-direction: column; }
    .filter-group label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 6px; }
    .filter-group select, .filter-group input { padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; background: #fff; min-width: 150px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #1a1a2e; }
    .stat-card .sub { font-size: 0.8rem; color: #94a3b8; margin-top: 2px; }
    .chart-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .chart-wrapper { position: relative; height: 400px; }
    .chart-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #1a1a2e; }
    .view-toggle { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .view-toggle button { padding: 8px 16px; border: 1px solid #e2e8f0; background: #fff; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
    .view-toggle button.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
    .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .data-table th { background: #f8fafc; font-weight: 600; color: #475569; position: sticky; top: 0; }
    .data-table tr:hover { background: #f8fafc; }
    .table-wrapper { max-height: 400px; overflow-y: auto; }
    .day-sun { color: #ef4444; }
    .day-sat { color: #f59e0b; }
    .day-fri { color: #10b981; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // Raw daily data with day of week - re-aggregated from source
    // Format: [date, quantity, dayOfWeek (0=Sun, 1=Mon, ... 6=Sat)]
    const RAW = [
      ["2024-07-02",129,2],["2024-07-03",22,3],["2024-07-09",204,2],["2024-07-10",18,3],["2024-07-11",66,4],
      ["2024-07-12",430,5],["2024-07-13",20,6],["2024-07-15",25,1],["2024-07-16",55,2],["2024-07-17",193,3],
      ["2024-07-18",179,4],["2024-07-19",165,5],["2024-07-20",32,6],["2024-07-23",82,2],["2024-07-24",35,3],
      ["2024-07-25",159,4],["2024-07-26",137,5],["2024-07-29",36,1],["2024-07-30",101,2],["2024-07-31",127,3],
      ["2024-08-01",128,4],["2024-08-03",50,6],["2024-08-05",28,1],["2024-08-06",100,2],["2024-08-07",63,3],
      ["2024-08-09",42,5],["2024-08-12",61,1],["2024-08-14",75,3],["2024-08-15",51,4],["2024-08-16",25,5],
      ["2024-08-23",26,5],["2024-08-24",15,6],["2024-08-27",25,2],["2024-09-02",15,1],["2024-09-06",21,5],
      ["2024-09-13",277,5],["2024-09-19",83,4],["2024-09-24",112,2],["2024-09-25",79,3],["2024-09-26",310,4],
      ["2024-09-28",20,6],["2024-09-30",89,1],["2024-10-01",112,2],["2024-10-02",44,3],["2024-10-04",224,5],
      ["2024-10-08",112,2],["2024-10-10",118,4],["2024-10-11",37,5],["2024-10-14",36,1],["2024-10-15",20,2],
      ["2024-10-17",213,4],["2024-10-18",49,5],["2024-10-23",137,3],["2024-10-24",81,4],["2024-10-25",229,5],
      ["2024-10-29",196,2],["2024-10-30",183,3],["2024-10-31",136,4],["2024-11-01",194,5],["2024-11-04",325,1],
      ["2024-11-05",39,2],["2024-11-06",270,3],["2024-11-07",412,4],["2024-11-08",269,5],["2024-11-12",173,2],
      ["2024-11-13",412,3],["2024-11-14",512,4],["2024-11-15",476,5],["2024-11-18",413,1],["2024-11-19",196,2],
      ["2024-11-20",351,3],["2024-11-21",417,4],["2024-11-22",435,5],["2024-11-25",219,1],["2024-11-26",110,2],
      ["2024-12-02",55,1],["2024-12-03",111,2],["2024-12-04",126,3],["2024-12-05",603,4],["2024-12-06",506,5],
      ["2024-12-07",3,6],["2024-12-09",313,1],["2024-12-10",187,2],["2024-12-11",195,3],["2024-12-12",575,4],
      ["2024-12-13",109,5],["2024-12-14",55,6],["2024-12-16",236,1],["2024-12-17",234,2],["2024-12-18",266,3],
      ["2024-12-19",226,4],["2024-12-20",36,5],["2024-12-23",69,1],["2024-12-30",20,1],["2025-01-07",71,2],
      ["2025-01-13",121,1],["2025-01-16",332,4],["2025-01-17",454,5],["2025-01-21",297,2],["2025-01-24",350,5],
      ["2025-01-29",93,3],["2025-01-30",367,4],["2025-02-04",94,2],["2025-02-05",166,3],["2025-02-06",80,4],
      ["2025-02-07",623,5],["2025-02-10",137,1],["2025-02-11",88,2],["2025-02-12",240,3],["2025-02-13",283,4],
      ["2025-02-14",430,5],["2025-02-17",166,1],["2025-02-18",99,2],["2025-02-21",240,5],["2025-02-24",303,1],
      ["2025-02-25",351,2],["2025-02-26",294,3],["2025-02-27",293,4],["2025-02-28",564,5],["2025-03-01",22,6],
      ["2025-03-03",368,1],["2025-03-04",444,2],["2025-03-05",220,3],["2025-03-06",454,4],["2025-03-07",671,5],
      ["2025-03-10",284,1],["2025-03-11",617,2],["2025-03-12",618,3],["2025-03-13",625,4],["2025-03-14",732,5],
      ["2025-03-17",253,1],["2025-03-18",423,2],["2025-03-19",481,3],["2025-03-20",520,4],["2025-03-21",201,5],
      ["2025-03-24",678,1],["2025-03-25",588,2],["2025-03-26",753,3],["2025-03-27",826,4],["2025-03-28",558,5],
      ["2025-04-01",574,2],["2025-04-02",266,3],["2025-04-03",610,4],["2025-04-04",744,5],["2025-04-05",15,6],
      ["2025-04-07",716,1],["2025-04-08",464,2],["2025-04-09",681,4],["2025-04-10",563,4],["2025-04-11",253,5],
      ["2025-04-14",170,1],["2025-04-15",357,2],["2025-04-16",472,3],["2025-04-17",531,4],["2025-04-18",203,5],
      ["2025-04-19",33,6],["2025-04-23",346,3],["2025-04-24",309,4],["2025-04-25",540,5],["2025-04-28",138,1],
      ["2025-05-01",294,4],["2025-05-02",707,5],["2025-05-05",119,1],["2025-05-06",90,2],["2025-05-07",80,3],
      ["2025-05-08",253,4],["2025-05-09",330,5],["2025-05-12",21,1],["2025-05-13",207,2],["2025-05-14",479,3],
      ["2025-05-15",493,4],["2025-05-16",424,5],["2025-05-19",77,1],["2025-05-20",217,2],["2025-05-21",111,3],
      ["2025-05-22",412,4],["2025-05-23",40,5],["2025-05-27",97,2],["2025-05-28",191,3],["2025-05-29",222,4],
      ["2025-05-30",144,5],["2025-06-03",110,2],["2025-06-09",17,1],["2025-06-10",143,2],["2025-06-13",23,5],
      ["2025-06-16",62,1],["2025-06-17",54,2],["2025-06-18",109,3],["2025-06-19",65,4],["2025-06-20",194,5],
      ["2025-06-21",27,6],["2025-06-23",22,1],["2025-06-24",21,2],["2025-06-25",58,3],["2025-06-26",318,4],
      ["2025-06-27",219,5],["2025-06-28",50,6],["2025-06-30",95,1]
    ];

    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    function App() {
      const [dateRange, setDateRange] = useState({start:'', end:''});
      const [viewMode, setViewMode] = useState('daily');
      const [showTable, setShowTable] = useState(false);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      const data = useMemo(() => RAW.map(r => ({
        dateStr: r[0], 
        visitors: r[1], 
        dow: r[2],
        date: new Date(r[0] + 'T12:00:00')
      })), []);

      const filteredData = useMemo(() => {
        return data.filter(row => {
          if (dateRange.start && row.dateStr < dateRange.start) return false;
          if (dateRange.end && row.dateStr > dateRange.end) return false;
          return true;
        });
      }, [data, dateRange]);

      const stats = useMemo(() => {
        const total = filteredData.reduce((s,r) => s + r.visitors, 0);
        const days = filteredData.length;
        const avg = days ? Math.round(total / days) : 0;
        const peak = filteredData.length ? Math.max(...filteredData.map(r => r.visitors)) : 0;
        const peakDay = filteredData.find(r => r.visitors === peak);
        
        // Day of week breakdown
        const byDow = [0,0,0,0,0,0,0];
        const countByDow = [0,0,0,0,0,0,0];
        filteredData.forEach(r => { byDow[r.dow] += r.visitors; countByDow[r.dow]++; });
        
        return { total, days, avg, peak, peakDate: peakDay ? peakDay.dateStr : '', peakDow: peakDay ? peakDay.dow : 0, byDow, countByDow };
      }, [filteredData]);

      const monthlyData = useMemo(() => {
        const byMonth = {};
        filteredData.forEach(row => {
          const m = row.date.getMonth();
          const y = row.date.getFullYear();
          const fy = m >= 6 ? y : y - 1;
          const key = `${fy}-${String(m).padStart(2,'0')}`;
          if (!byMonth[key]) byMonth[key] = {month: m, fy, total: 0, days: 0};
          byMonth[key].total += row.visitors;
          byMonth[key].days++;
        });
        return Object.values(byMonth).sort((a,b) => {
          const aIdx = a.month >= 6 ? a.month - 6 : a.month + 6;
          const bIdx = b.month >= 6 ? b.month - 6 : b.month + 6;
          return (a.fy - b.fy) || (aIdx - bIdx);
        });
      }, [filteredData]);

      const chartData = useMemo(() => {
        if (viewMode === 'daily') {
          return {
            labels: filteredData.map(r => r.dateStr),
            datasets: [{
              label: 'Daily Visitors',
              data: filteredData.map(r => r.visitors),
              borderColor: '#3b82f6',
              backgroundColor: '#3b82f640',
              fill: true,
              tension: 0.3,
              pointRadius: 2
            }]
          };
        } else if (viewMode === 'monthly') {
          return {
            labels: monthlyData.map(m => `${MONTHS[m.month]} ${m.fy + 1}`),
            datasets: [{
              label: 'Monthly Visitors',
              data: monthlyData.map(m => m.total),
              backgroundColor: '#3b82f6',
              borderRadius: 6
            }]
          };
        } else {
          return {
            labels: DAYS,
            datasets: [{
              label: 'Total by Day of Week',
              data: stats.byDow,
              backgroundColor: ['#ef4444','#64748b','#64748b','#64748b','#64748b','#10b981','#f59e0b'],
              borderRadius: 6
            }]
          };
        }
      }, [filteredData, monthlyData, viewMode, stats]);

      useEffect(() => {
        if (!chartRef.current || !chartData.datasets.length) return;
        if (chartInstance.current) chartInstance.current.destroy();
        
        const config = viewMode === 'daily' ? {
          type: 'line',
          data: chartData,
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: { 
              tooltip: { callbacks: { 
                title: ctx => { const d = new Date(ctx[0].label + 'T12:00:00'); return `${DAYS[d.getDay()]}, ${formatDate(ctx[0].label)}`; },
                label: ctx => `${ctx.parsed.y.toLocaleString()} visitors` 
              }},
              legend: { display: false }
            },
            scales: { 
              x: { title: { display: true, text: 'Date' }, ticks: { maxTicksLimit: 15, callback: function(val, idx) { return this.getLabelForValue(val).substring(5); }}},
              y: { beginAtZero: true, title: { display: true, text: 'Visitors' }, ticks: { callback: v => v.toLocaleString() }}
            }
          }
        } : {
          type: 'bar',
          data: chartData,
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
              tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toLocaleString()} visitors` }},
              legend: { display: false }
            },
            scales: { 
              y: { beginAtZero: true, title: { display: true, text: 'Visitors' }, ticks: { callback: v => v.toLocaleString() }}
            }
          }
        };
        
        chartInstance.current = new Chart(chartRef.current, config);
      }, [chartData, viewMode]);

      const formatDate = (dateStr) => {
        const d = new Date(dateStr + 'T12:00:00');
        return d.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
      };

      const getDayClass = (dow) => {
        if (dow === 0) return 'day-sun';
        if (dow === 6) return 'day-sat';
        if (dow === 5) return 'day-fri';
        return '';
      };

      return (
        <div className="container">
          <h1>ðŸ“Š Field Trip Attendance Dashboard</h1>
          <p className="subtitle">Discovery Place Science â€” FY25 (July 2024 â€“ June 2025)</p>

          <div className="filters">
            <div className="filter-group">
              <label>Start Date</label>
              <input type="date" value={dateRange.start} onChange={e => setDateRange(p => ({...p, start: e.target.value}))} min="2024-07-01" max="2025-06-30" />
            </div>
            <div className="filter-group">
              <label>End Date</label>
              <input type="date" value={dateRange.end} onChange={e => setDateRange(p => ({...p, end: e.target.value}))} min="2024-07-01" max="2025-06-30" />
            </div>
            <button onClick={() => setDateRange({start:'', end:''})} style={{padding:'10px 16px', border:'1px solid #e2e8f0', background:'#fff', borderRadius:'8px', cursor:'pointer'}}>Reset</button>
          </div>

          <div className="stats">
            <div className="stat-card">
              <div className="label">Total Visitors</div>
              <div className="value">{stats.total.toLocaleString()}</div>
            </div>
            <div className="stat-card">
              <div className="label">Days with Trips</div>
              <div className="value">{stats.days}</div>
            </div>
            <div className="stat-card">
              <div className="label">Avg per Day</div>
              <div className="value">{stats.avg.toLocaleString()}</div>
            </div>
            <div className="stat-card">
              <div className="label">Peak Day</div>
              <div className="value">{stats.peak.toLocaleString()}</div>
              <div className="sub">{stats.peakDate ? `${DAYS[stats.peakDow]}, ${formatDate(stats.peakDate)}` : ''}</div>
            </div>
          </div>

          <div className="chart-container">
            <div className="view-toggle">
              <button className={viewMode === 'daily' ? 'active' : ''} onClick={() => setViewMode('daily')}>Daily View</button>
              <button className={viewMode === 'monthly' ? 'active' : ''} onClick={() => setViewMode('monthly')}>Monthly View</button>
              <button className={viewMode === 'dow' ? 'active' : ''} onClick={() => setViewMode('dow')}>By Day of Week</button>
              <button onClick={() => setShowTable(!showTable)} style={{marginLeft:'auto', background: showTable ? '#fee2e2' : '#fff'}}>
                {showTable ? 'Hide' : 'Show'} Data Table
              </button>
            </div>
            <div className="chart-wrapper">
              <canvas ref={chartRef}></canvas>
            </div>
          </div>

          {showTable && (
            <div className="chart-container">
              <div className="chart-title">Raw Data (for verification)</div>
              <p style={{fontSize:'0.85rem', color:'#64748b', marginBottom:'10px'}}>
                <span className="day-fri">â–  Friday</span> &nbsp; <span className="day-sat">â–  Saturday</span> &nbsp; <span className="day-sun">â–  Sunday</span>
              </p>
              <div className="table-wrapper">
                <table className="data-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Day</th>
                      <th>Visitors</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredData.map((r, i) => (
                      <tr key={i}>
                        <td>{formatDate(r.dateStr)}</td>
                        <td className={getDayClass(r.dow)}>{DAYS[r.dow]}</td>
                        <td>{r.visitors.toLocaleString()}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          <div className="chart-container">
            <div className="chart-title">Day of Week Summary</div>
            <table className="data-table">
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Total Visitors</th>
                  <th># of Days</th>
                  <th>Avg per Day</th>
                </tr>
              </thead>
              <tbody>
                {DAYS.map((day, i) => (
                  <tr key={i}>
                    <td className={getDayClass(i)}>{day}</td>
                    <td>{stats.byDow[i].toLocaleString()}</td>
                    <td>{stats.countByDow[i]}</td>
                    <td>{stats.countByDow[i] ? Math.round(stats.byDow[i] / stats.countByDow[i]).toLocaleString() : 0}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
