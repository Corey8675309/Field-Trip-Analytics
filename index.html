import React, { useState, useMemo, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
import { Calendar, Users, TrendingUp } from 'lucide-react';

const FieldTripDashboard = () => {
  const [fileData, setFileData] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    const loadData = async () => {
      try {
        const csvText = await window.fs.readFile('consolidated_field_trips (4).csv', { encoding: 'utf8' });
        setFileData(csvText);
        setError(null);
      } catch (error) {
        console.error('Error loading file:', error);
        setError('File not found. Please upload your CSV file to view the dashboard.');
      }
    };
    loadData();
  }, []);

  const data = useMemo(() => {
    if (!fileData) return { records: [], chaperones: [], organizations: [] };

    const lines = fileData.trim().split('\n').slice(1);
    
    const records = lines.map(line => {
      const match = line.match(/"([^"]+)",(\d{4}-\d{2}-\d{2}),(-?\d+),(-?\d+)/);
      if (!match) return null;
      
      const [, name, dateStr, qty, heldQty] = match;
      const totalQty = parseInt(qty) + parseInt(heldQty);
      
      const [year, month, day] = dateStr.split('-').map(Number);
      const date = new Date(Date.UTC(year, month - 1, day));
      
      return {
        name: name.trim(),
        date: date,
        dateStr: dateStr,
        quantity: parseInt(qty),
        heldQuantity: parseInt(heldQty),
        totalQuantity: totalQty
      };
    }).filter(r => r && r.totalQuantity > 0);

    const isChaperoneName = (name) => {
      const nameLower = name.toLowerCase();
      const orgKeywords = ['school', 'elementary', 'middle', 'high', 'academy', 'center', 
                          'district', 'program', 'church', 'college', 'university', 
                          'charter', 'christian', 'catholic', 'preschool', 'daycare',
                          'ymca', 'ywca', 'learning', 'education', 'prep', 'steam',
                          'foundation', 'association', 'institute', 'troop', 'homeschool'];
      
      const hasOrgKeyword = orgKeywords.some(keyword => nameLower.includes(keyword));
      const hasTwoNames = name.split(' ').length >= 2 && name.split(' ').length <= 5;
      
      return (!hasOrgKeyword && hasTwoNames) || name === 'Anonymous Buyer';
    };

    const chaperones = records.filter(r => isChaperoneName(r.name));
    const organizations = records.filter(r => !isChaperoneName(r.name));

    return { records, chaperones, organizations };
  }, [fileData]);

  const monthlyData = useMemo(() => {
    const months = {};
    data.records.forEach(record => {
      const monthKey = record.dateStr.slice(0, 7);
      const monthLabel = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', timeZone: 'UTC' }).format(record.date);
      if (!months[monthKey]) {
        months[monthKey] = { month: monthLabel, guests: 0, bookings: 0, sortKey: monthKey };
      }
      months[monthKey].guests += record.totalQuantity;
      months[monthKey].bookings += 1;
    });
    
    return Object.values(months).sort((a, b) => a.sortKey.localeCompare(b.sortKey));
  }, [data]);

  const dayOfWeekData = useMemo(() => {
    const days = { Monday: 0, Tuesday: 0, Wednesday: 0, Thursday: 0, Friday: 0, Saturday: 0, Sunday: 0 };
    const dayGroups = { Monday: 0, Tuesday: 0, Wednesday: 0, Thursday: 0, Friday: 0, Saturday: 0, Sunday: 0 };
    const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    data.records.forEach(record => {
      const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'long', timeZone: 'UTC' }).format(record.date);
      days[dayName] += record.totalQuantity;
      dayGroups[dayName] += 1;
    });
    
    return dayOrder.map(day => ({ 
      day, 
      guests: days[day],
      groups: dayGroups[day]
    })).filter(d => d.guests > 0);
  }, [data]);

  const dailyData = useMemo(() => {
    const days = {};
    data.records.forEach(record => {
      const dayKey = record.dateStr;
      if (!days[dayKey]) {
        days[dayKey] = { date: dayKey, guests: 0, bookings: 0, sortKey: dayKey };
      }
      days[dayKey].guests += record.totalQuantity;
      days[dayKey].bookings += 1;
    });
    
    return Object.values(days).sort((a, b) => a.sortKey.localeCompare(b.sortKey));
  }, [data]);

  const groupBreakdown = useMemo(() => {
    const groups = {};
    
    data.organizations.forEach(record => {
      if (!groups[record.name]) {
        groups[record.name] = {
          name: record.name,
          visits: [],
          totalGuests: 0,
          visitCount: 0
        };
      }
      groups[record.name].visits.push({
        date: record.dateStr,
        guests: record.totalQuantity
      });
      groups[record.name].totalGuests += record.totalQuantity;
      groups[record.name].visitCount += 1;
    });
    
    Object.values(groups).forEach(group => {
      group.visits.sort((a, b) => a.date.localeCompare(b.date));
    });
    
    return Object.values(groups).sort((a, b) => b.totalGuests - a.totalGuests);
  }, [data]);

  const metrics = useMemo(() => {
    const totalGuests = data.records.reduce((sum, r) => sum + r.totalQuantity, 0);
    const totalBookings = data.organizations.length;
    const chaperoneCount = data.chaperones.reduce((sum, r) => sum + r.totalQuantity, 0);
    const avgGroupSize = totalBookings > 0 ? totalGuests / totalBookings : 0;

    return { totalGuests, totalBookings, chaperoneCount, avgGroupSize };
  }, [data]);

  const keyInsights = useMemo(() => {
    // Peak months
    const monthlyGuests = {};
    data.records.forEach(record => {
      const monthKey = record.dateStr.slice(0, 7);
      const monthName = new Intl.DateTimeFormat('en-US', { month: 'long', timeZone: 'UTC' }).format(record.date);
      if (!monthlyGuests[monthName]) {
        monthlyGuests[monthName] = 0;
      }
      monthlyGuests[monthName] += record.totalQuantity;
    });
    
    const sortedMonths = Object.entries(monthlyGuests).sort((a, b) => b[1] - a[1]);
    const peakMonth1 = sortedMonths[0] || ['', 0];
    const peakMonth2 = sortedMonths[1] || ['', 0];
    const peakTraffic = ((peakMonth1[1] + peakMonth2[1]) / metrics.totalGuests * 100).toFixed(0);

    // Repeat visits
    const totalVisits = groupBreakdown.reduce((sum, g) => sum + g.visitCount, 0);
    const uniqueOrgs = groupBreakdown.length;
    const repeatRate = uniqueOrgs > 0 ? (((totalVisits - uniqueOrgs) / totalVisits) * 100).toFixed(0) : 0;

    // Top organizations concentration
    const top10Guests = groupBreakdown.slice(0, 10).reduce((sum, g) => sum + g.totalGuests, 0);
    const top10Percentage = ((top10Guests / metrics.totalGuests) * 100).toFixed(0);

    // Multi-visit organizations
    const multiVisitOrgs = groupBreakdown.filter(g => g.visitCount > 1);
    const multiVisitGuests = multiVisitOrgs.reduce((sum, g) => sum + g.totalGuests, 0);
    const multiVisitPercentage = ((multiVisitGuests / metrics.totalGuests) * 100).toFixed(0);

    // Weekday vs Weekend
    const weekdayGuests = data.records.filter(r => {
      const day = new Intl.DateTimeFormat('en-US', { weekday: 'long', timeZone: 'UTC' }).format(r.date);
      return !['Saturday', 'Sunday'].includes(day);
    }).reduce((sum, r) => sum + r.totalQuantity, 0);
    const weekdayPercentage = ((weekdayGuests / metrics.totalGuests) * 100).toFixed(0);

    // Quarterly breakdown
    const quarters = {
      'Q1 (Jan-Mar)': { guests: 0, months: ['01', '02', '03'] },
      'Q2 (Apr-Jun)': { guests: 0, months: ['04', '05', '06'] },
      'Q3 (Jul-Sep)': { guests: 0, months: ['07', '08', '09'] },
      'Q4 (Oct-Dec)': { guests: 0, months: ['10', '11', '12'] }
    };

    data.records.forEach(record => {
      const month = record.dateStr.slice(5, 7);
      Object.entries(quarters).forEach(([qName, qData]) => {
        if (qData.months.includes(month)) {
          qData.guests += record.totalQuantity;
        }
      });
    });
    
    return {
      peakMonth1: peakMonth1[0],
      peakMonth1Count: peakMonth1[1],
      peakMonth2: peakMonth2[0],
      peakMonth2Count: peakMonth2[1],
      peakTraffic,
      repeatRate,
      top10Percentage,
      multiVisitOrgs: multiVisitOrgs.length,
      multiVisitPercentage,
      weekdayPercentage,
      quarters
    };
  }, [data, metrics, groupBreakdown]);

  if (!fileData) {
    return (
      <div className="w-full bg-gray-50 p-6 min-h-screen flex items-center justify-center">
        <div className="text-center">
          {error ? (
            <div className="bg-white rounded-lg shadow-sm p-8 max-w-md">
              <div className="text-red-500 mb-4">
                <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <h2 className="text-xl font-bold text-gray-900 mb-2">File Not Found</h2>
              <p className="text-gray-600 mb-4">{error}</p>
              <p className="text-sm text-gray-500">Upload your CSV file to the conversation to view the dashboard.</p>
            </div>
          ) : (
            <>
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading field trip data...</p>
            </>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="w-full bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">Field Trip Analytics Dashboard</h1>
          <p className="text-gray-600">Fiscal Year 2025 (July 1, 2024 - June 30, 2025)</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 mb-1">Total Guests</p>
                <p className="text-3xl font-bold text-blue-600">{metrics.totalGuests.toLocaleString()}</p>
              </div>
              <Users className="w-12 h-12 text-blue-200" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 mb-1">Unique Groups</p>
                <p className="text-3xl font-bold text-indigo-600">{groupBreakdown.length}</p>
              </div>
              <Calendar className="w-12 h-12 text-indigo-200" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 mb-1">Total Bookings</p>
                <p className="text-3xl font-bold text-green-600">{metrics.totalBookings}</p>
              </div>
              <Calendar className="w-12 h-12 text-green-200" />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600 mb-1">Avg Group Size</p>
                <p className="text-3xl font-bold text-orange-600">{Math.round(metrics.avgGroupSize)}</p>
              </div>
              <TrendingUp className="w-12 h-12 text-orange-200" />
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">Key Metrics</h2>
          
          <div className="space-y-4">
            <div className="bg-blue-50 rounded-lg p-5">
              <h3 className="text-lg font-semibold text-blue-900 mb-2">Peak Seasons</h3>
              <p className="text-gray-700">
                {keyInsights.peakMonth1} ({keyInsights.peakMonth1Count.toLocaleString()}) and {keyInsights.peakMonth2} ({keyInsights.peakMonth2Count.toLocaleString()}) accounted for <span className="font-bold">{keyInsights.peakTraffic}% of annual traffic</span>.
              </p>
            </div>

            <div className="bg-green-50 rounded-lg p-5">
              <h3 className="text-lg font-semibold text-green-900 mb-2">Customer Loyalty</h3>
              <p className="text-gray-700">
                <span className="font-bold">{keyInsights.multiVisitOrgs} organizations ({((keyInsights.multiVisitOrgs / groupBreakdown.length) * 100).toFixed(0)}%)</span> returned for multiple visits, generating <span className="font-bold">{keyInsights.multiVisitPercentage}% of total attendance</span>.
              </p>
            </div>

            <div className="bg-amber-50 rounded-lg p-5">
              <h3 className="text-lg font-semibold text-amber-900 mb-2">Top Customer Concentration</h3>
              <p className="text-gray-700">
                Top 10 organizations represent <span className="font-bold">{keyInsights.top10Percentage}% of total visitors</span>, indicating strong relationships with key partners.
              </p>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
              {Object.entries(keyInsights.quarters).map(([quarter, data]) => (
                <div key={quarter} className="bg-gray-50 rounded-lg p-4 text-center">
                  <div className="text-sm text-gray-600 mb-1">{quarter}</div>
                  <div className="text-2xl font-bold text-gray-900">{data.guests.toLocaleString()}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    {((data.guests / metrics.totalGuests) * 100).toFixed(0)}% of annual
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">Monthly Guest Trends</h2>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={monthlyData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="month" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Line type="monotone" dataKey="guests" stroke="#0088FE" strokeWidth={2} name="Total Guests" />
            </LineChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">Daily Activity Pattern</h2>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={dailyData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" tick={{ fontSize: 8 }} angle={-45} textAnchor="end" height={80} interval="preserveStartEnd" />
              <YAxis />
              <Tooltip />
              <Line type="monotone" dataKey="guests" stroke="#FF8042" strokeWidth={2} name="Daily Guests" dot={false} />
            </LineChart>
          </ResponsiveContainer>
          <p className="text-xs text-gray-500 mt-2">Complete FY25 daily activity</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Most Popular Days - Guests</h2>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dayOfWeekData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="day" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="guests" fill="#8884D8" name="Total Guests" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Most Popular Days - Groups</h2>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dayOfWeekData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="day" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="groups" fill="#82ca9d" name="Number of Groups" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Top 10 Groups by Total Guests</h2>
            <ResponsiveContainer width="100%" height={400}>
              <BarChart data={groupBreakdown.slice(0, 10)} layout="vertical" margin={{ left: 150 }}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis type="number" />
                <YAxis type="category" dataKey="name" width={140} tick={{ fontSize: 11 }} />
                <Tooltip />
                <Bar dataKey="totalGuests" fill="#3b82f6" name="Total Guests" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Top 10 Groups by Number of Visits</h2>
            <ResponsiveContainer width="100%" height={400}>
              <BarChart 
                data={[...groupBreakdown].sort((a, b) => b.visitCount - a.visitCount).slice(0, 10)} 
                layout="vertical" 
                margin={{ left: 150 }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis type="number" />
                <YAxis type="category" dataKey="name" width={140} tick={{ fontSize: 11 }} />
                <Tooltip />
                <Bar dataKey="visitCount" fill="#10b981" name="Number of Visits" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
    </div>
  );
};

export default FieldTripDashboard;